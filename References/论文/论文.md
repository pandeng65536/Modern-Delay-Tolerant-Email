### **摘 要**

在深空高延迟、频中断的网络环境中，建立可靠的通信机制很重要。电子邮件作为基础通信工具，其在延迟容忍网络（DTN）环境下的适应性方案也很重要。本论文旨在对现代DTN电子邮件方案（`draft-johnson-dtn-interplanetary-smtp`）进行系统性的仿真与分析，以评估其在模拟深空环境中的可行性与局限性。

为达成此目标，本研究设计并实现了一个基于Docker的星际网络模拟平台。该平台集成了Postfix、Dovecot、ION-DTN及BPMail网关等真实世界软件，构建了包含邮件收发、DTN中继和用户客户端的完整通信链路，并能模拟网络延迟。

实验结果表明，该方案在用户与邮件服务器位于同一网络区域的基线场景下能够有效工作。然而，本研究设计的“用户跨星球移动”测试场景揭示了其缺陷：当用户漫游至远端网络并尝试访问其归属邮件服务器时，其实时同步协议（IMAP/SMTP）将绕过DTN网关进行直接连接，导致通信性能随延迟增加而急剧下降，以致系统不可用。

因此，本论文得出结论，该方案在设计上缺乏对用户移动性的支持。针对这一局限，本文最后提出了一个基于“按需同步代理”的概念模型，通过在本地设置中间代理来解耦用户实时交互与后台异步数据传输，为解决该问题提供了一种研究方向。

**关键词**：延迟容忍网络；DTN；电子邮件；用户移动性；系统仿真；按需同步代理

Chapter-1 Introduction 

 1.1 Background . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1

随着人类航天技术的不断进步，我们正迎来一个崭新的时代：从地球走向太空。NASA的阿耳忒弥斯计划、SpaceX的火星探索愿景等项目，都预示着未来人类将可能在其他星球上建立永久性基地，甚至实现行星间的移民。然而，要实现这一宏伟目标，一个稳定可靠的行星际通信基础设施至关重要。

传统的互联网协议（TCP/IP）在地球上运行得非常出色，但它并不适用于深空通信。行星际通信面临着**极高的通信延迟**（光速在地球与火星之间需要数分钟甚至数十分钟）、**极低的带宽**以及**频繁的链路中断**等极端挑战。这些特性使得传统的“端到端”实时连接模型几乎无法工作。为了解决这些问题，学术界和工业界提出了**延迟容忍网络（Delay-Tolerant Networking, DTN）**的概念。DTN的核心思想是**“存储-携带-转发”（store-carry-forward）**机制，它不依赖于实时连接，而是通过网络节点（如航天器、轨道卫星或行星基地）的物理移动来缓存和传递数据，从而在极端环境中实现数据的可靠传输。

 1.2 Motivation. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2

尽管DTN作为行星际通信的理论基础已被广泛认可，但其在实际应用和部署方面的发展却相对滞后。首先，DTN协议栈与现有的互联网基础设施存在巨大差异，使得在现有平台上开发和部署DTN应用面临着**“造轮子”**的难题。这意味着开发者不仅需要设计上层应用，还需要重新构建底层网络架构。为了克服这一障碍，研究人员做出了诸多努力：

- **模块化协议设计：** DTN协议栈被设计为模块化的层级结构，如捆绑协议（Bundle Protocol, BP）作为传输层，使其能与不同的底层传输协议（如TCP、UDP或特定的射频协议）灵活集成，降低了开发难度。
- **与现有网络融合：** 研究工作致力于使DTN与传统的TCP/IP网络共存，例如通过DTN网关实现数据在两种网络间的无缝转发，使得DTN设备可以接入部分现有的网络服务，减少了基础设施的重建成本。

在DTN应用层，**电子邮件**作为最基础和重要的通信工具之一，其在DTN环境下的实现也受到了广泛关注。研究人员致力于设计一种**既能利用DTN的优势，又能与现有电子邮件系统（SMTP）兼容**的方案。其中，IETF草案 `draft-johnson-dtn-interplanetary-smtp` 便是此类方案的一个重要尝试。该草案提出了一种在DTN环境下运行SMTP服务的具体方法，为我们提供了将理论设想转化为实际应用研究的宝贵蓝本。

 1.3 Research Question and Objectives . . . . . . . . . . . . . . . . . . . . . 3

本研究旨在对`draft-johnson-dtn-interplanetary-smtp`方案进行系统性的仿真和分析，以回答以下核心问题：该方案在模拟的深空环境中是否可行？其设计存在哪些潜在的局限性和不足？

为达成这一目标，本研究将具体完成以下工作：

- **构建DTN仿真环境：** 搭建一个能够模拟深空通信特性的软件仿真平台，包括高延迟、低带宽和链路间歇性中断等环境参数，为后续实验提供基础。
- **实现DTN电子邮件服务：** 基于`draft-johnson-dtn-interplanetary-smtp`草案，搭建一个能够在仿真环境中运行的延迟容忍电子邮件服务原型，实现消息的发送、存储、转发和接收功能。
- **设计并执行场景验证：** 设计一个具体的场景，例如一位宇航员从火星基地移动到月球基地后，如何继续通过该网络接收和发送邮件。通过模拟这一场景，对Johnson的方案进行功能性验证和性能评估。
- **分析与评估：** 收集并分析关键性能指标，如邮件的平均投递延迟、成功率等。在此基础上，深入剖析该方案在处理消息顺序、数据完整性、安全性以及资源管理等方面的优缺点，并识别其在实际部署中可能遇到的局限性。

最终，本研究不仅将验证`draft-johnson-dtn-interplanetary-smtp`方案的可行性，更将通过分析，为未来DTN应用的设计和优化提供有价值的洞见，从而为构建真正的行星际通信网络贡献力量。

 1.4 Dissertation overview. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4



Chapter2 Literature Review

#### **2.1 引言**

本章节旨在系统性地回顾与延迟容忍网络（DTN）及其在电子邮件应用中的相关研究。首先，本章将阐述星际网络环境的根本特征，并分析传统TCP/IP协议簇在此背景下的固有局限性，从而引出延迟容忍网络（DTN）作为核心解决范式的必要性。随后，章节将深入探讨DTN的核心机制与分层架构。在此基础上，将焦点转向具体的应用场景——电子邮件，分析传统SMTP协议的“对话式”特性如何与DTN环境产生冲突。继而，本章将重点剖析当前为解决该问题而提出的，用网关将DTN与TCP/IP网络相结合的网关方案。其定义草案为`draft-johnson-dtn-interplanetary-smtp`[1]，并结合阐述了网关数据封装格式的`draft-blanchet-dtn-email-over-bp`[3]，以及解决关键依赖问题的DNS草案[2]。最后，本章将介绍一个关键的开源实现BPMail [4]，并总结当前研究的现状，明确指出其中存在的局限性，从而为本毕业设计的研究目标和价值提供理论依据。

#### **2.2 星际网络的特点**

星际网络（Interplanetary Network）环境与我们熟悉的地面互联网存在根本性差异，主要体现在以下几个方面 [5]：

1. **超长传播延迟（Extremely Long Propagation Delays）**：由于天体之间距离很远，信号在行星际间的传播动辄需要数分钟至数小时（如地球至火星，以光速需要3-22分钟）。
2. **频繁的连接中断（Frequent and Lengthy Disruptions）**：由天体遮挡、卫星沿轨道不断运动等因素导致，通信链路可能中断数小时甚至数天。
3. **非对称的信道带宽（Asymmetric Channel Bandwidth）**：通常从地面到深空的“上行”带宽远高于从深空到地面的“下行”带宽。
4. **较高的误码率（High Bit Error Rates）**：空间辐射和长距离传输导致数据传输的错误率远高于地面信道。

传统的TCP/IP协议簇为低延迟、高稳定性的地面互联网设计，其核心假设在星际网络环境中被颠覆，导致其失效。其主要局限性体现在连接建立失败、"对话式"协议失效和拥塞控制误判等方面[6]。因此，必须寻求一种全新的网络架构。

#### **2.3 延迟容忍网络（DTN）核心机制与架构**

为应对上述挑战，由Vint Cerf等人提出的延迟容忍网络（DTN）应运而生 [7]。DTN通过捆绑协议（Bundle Protocol, BP）[8]、存储-携带-转发（Store-Carry-and-Forward）机制以及可选的托管传输（Custody Transfer）功能，打破了对端到端实时路径的依赖，实现了在挑战性网络中的可靠通信。DTN通常作为覆盖网络，位于网络模型的应用层和传输层之间，通过汇聚层适配器与各种底层网络协同工作。

![image-20250812000145111](./../../../Users/18932/AppData/Roaming/Typora/typora-user-images/image-20250812000145111.png)

#### **2.4 传统电子邮件系统架构与协议**

传统电子邮件系统是一个经典的、分布式的存储转发系统，由多个逻辑组件和一套标准化的协议协同工作，以实现全球范围内的消息传递。

##### **2.4.1 核心组件**

![image-20250812022626478](./.assets/Email_architecture.png)

如图，一个典型的电子邮件交互过程涉及到以下核心组件：

1. **邮件用户代理 (Mail User Agent, MUA)**：这是用户直接交互的客户端软件，如Mozilla Thunderbird，Microsoft Outlook等。MUA负责邮件的撰写、显示、管理，并通过标准协议与邮件服务器通信。
2. **邮件提交代理 (Mail Submission Agent, MSA)**：MUA将待发送的邮件提交给MSA。MSA负责验证用户身份，并对邮件格式进行初步检查，然后将邮件传递给MTA。通常，MSA的功能由MTA软件（如Postfix）在特定的端口（587端口）上提供。
3. **邮件传输代理 (Mail Transfer Agent, MTA)**：MTA是邮件系统的核心中枢，扮演着“邮局”的角色，例如Postfix、Sendmail等。它的主要职责是根据邮件地址中的域名，通过查询DNS的MX记录，找到下一跳的MTA，并使用SMTP协议将邮件一站一站地中继转发出去，直至到达目标MTA。
4. **邮件投递代理 (Mail Delivery Agent, MDA)**：当邮件到达最终目的地的MTA后，由MDA负责将邮件放入对应用户的本地邮箱（Mailbox）中。如Dovecot等软件就具备强大的MDA功能，可以进行邮件过滤和分类存储。
5. **邮件存储 (Message Store)**：这是服务器上实际存放电子邮件的物理或逻辑空间，是邮件生命周期中静态存放的“终点”。它本身是一个被动组件，由MDA负责向其中写入邮件，并由IMAP/POP3服务器负责从中读取邮件以响应MUA的请求。常见的存储格式主要有两种：
   - **mbox**：将一个用户的所有邮件串联存储在单个文件中。这种格式实现简单，但在高并发读写和数据恢复方面存在不足。
   - **Maildir**：为每封邮件创建一个独立的文件，并存放在特定的目录结构中（如`cur`、`new`、`tmp`）。这种格式避免了文件锁定问题，健壮性更高，是现代邮件系统中更常见的选择。
   - **邮件存储 (Message Store)**：这是服务器上实际存放电子邮件的物理或逻辑空间，是邮件生命周期中静态存放的“终点”。它本身是一个被动组件，由MDA负责向其中写入邮件，并由IMAP/POP3服务器负责从中读取邮件以响应MUA的请求。常见的存储格式主要有两种：
     - **mbox**：将一个用户的所有邮件串联存储在单个文件中。这种格式实现简单，但在高并发读写和数据恢复方面存在不足。
     - **Maildir**：为每封邮件创建一个独立的文件，并存放在特定的目录结构中（如`cur`、`new`、`tmp`）。这种格式避免了文件锁定问题，健壮性更高，是现代邮件系统中更常见的选择。

##### **2.4.2 关键协议**

上述组件之间的通信依赖于以下关键协议：

- **SMTP (Simple Mail Transfer Protocol)**：简单邮件传输协议是邮件**发送和中继**的标准。它是一种基于TCP的、文本驱动的“推”协议。其工作模式具有显著的**“对话式”（Conversational）**或**“交互式”（Interactive）**特征。一次成功的邮件传输需要客户端与服务器之间进行一系列严格按顺序执行的命令-响应交互，例如：
  - `EHLO/HELO`: 客户端向服务器“问好”并声明身份。
  - `AUTH`: 进行身份认证。
  - `MAIL FROM`: 声明发件人地址。
  - `RCPT TO`: 声明一个或多个收件人地址。
  - `DATA`: 告知服务器即将开始传输邮件内容。
  - `QUIT`: 结束会话。 每一步命令发出后，客户端都必须等待并解析服务器返回的三位数状态码（如`250 OK`），确认成功后才能继续下一步。这种紧密耦合的交互模式对底层网络的实时性和稳定性要求极高。
- **POP3 (Post Office Protocol 3) / IMAP (Internet Message Access Protocol)**：这两个协议用于MUA从服务器**获取和管理**邮件。
  - **POP3**是一种相对简单的“拉”协议，通常会将服务器上所有邮件下载到本地客户端，并随后从服务器上删除。
  - **IMAP**则更为强大和现代，它允许用户在服务器上直接管理邮件（如创建文件夹、标记已读/未读），并能在多个MUA之间同步状态，邮件本身主要存储在服务器端。

可见，传统电子邮件系统是一个由多个逻辑组件和交互式协议构成的复杂生态系统。它的可靠运行，其设计的基石，是对一个低延迟、高可靠性、持续可用的底层网络（即TCP/IP互联网）的假定。正是这一根本性的假定，使其在面对DTN所代表的挑战性网络环境时，显得力不从心。

#### **2.5 DTN电子邮件的标准化方案**

为将传统邮件系统适配到DTN网络，研究界提出了一系列协同工作的标准化草案，它们分别从服务交互、数据格式和依赖解析三个层面定义了一个完整的解决方案。

##### **2.5.1 定义务交互：`draft-johnson-dtn-interplanetary-smtp`**

该草案提出了一种基于SMTP网关的解决方案，它的核心是在DTN与TCP/IP网络之间添加一个网关，网关可以把发邮件所用的SMTP依赖的TCP协议转换成BP协议，也可以把BP协议包装的SMTP邮件还原成TCP协议，从而实现传统邮件服务器与DTN网络无缝对接。其详细工作流程如下：

1. **终结SMTP会话**：网关对本地邮件服务器（如Postfix）伪装成一个标准的SMTP服务器。当Postfix向DTN域内地址发送邮件时，它会与DTN网关建立一个标准的SMTP连接。
2. **打包邮件事务**：网关接收并完成整个SMTP“对话”，收集到发件人、收件人、邮件头和邮件体等全部信息。
3. **触发Bundle封装**：网关将收集到的完整邮件事务，触发封装成一个或多个Bundles的过程，并将其发往DTN网络。

该方案很好地确保了对现有邮件基础设施的兼容性。它解决了“如何接入”的问题，但并未详细规定封装后的Bundle内部应该是什么样的精确格式。

##### **2.5.2 定义数据格式：`draft-blanchet-dtn-email-over-bp`**

**为补充和完善网关方案，`draft-blanchet-dtn-email-over-bp`[3]草案应运而生。它并非一个竞争方案，而是为“邮件如何被封装在Bundle中”这一问题提供了详细的技术规范，定义了一个标准的邮件Bundle格式。** 其核心内容包括：

- **数据模型**：它详细规定了如何将一封符合SMTP格式的邮件映射到一个BP协议的 Bundle中。
- **块（Block）的定义**：草案建议将完整的邮件（包括头和体）作为Bundle的主载荷块（Primary Block）或一个独立的载荷块（Payload Block）。
- **元数据映射**：它探讨了将邮件的关键头字段（如`Message-ID`）映射到Bundle元数据的可能性，以便进行更高效的处理。

因此，这两个草案是**相辅相成**的：Johnson的草案定义了网关**“做什么”**（与SMTP世界交互），而Blanchet的草案则定义了网关**“怎么做”**（如何生成一个标准化的邮件Bundle）。一个完整的、标准化的网关实现应当同时遵循这两个草案的指导。

##### **2.5.3 解决前提依赖：`draft-johnson-dtn-interplanetary-dns`**

邮件路由依赖于DNS查询MX记录。标准DNS同样无法在DTN环境中工作。`draft-johnson-dtn-interplanetary-dns`[2]草案解决了这一关键的**前提依赖问题**。它提出一个DTN-DNS网关，负责将本地的DNS请求打包成Bundle，在DTN网络中进行查询，并将结果以Bundle的形式返回。该方案是整个DTN邮件系统能够找到正确投递路径的基础保障。

#### **2.6 实践工具：BPMail网关实现**

理论草案的价值在于其实践可行性。由加州州立大学发起的ASCENT项目[4]中，开发了一款名为**BPMail**的开源软件。BPMail是上述网关思想的一个具体实现，它被设计为可以集成到Postfix邮件系统中的一个邮件投递代理。

BPMail的工作流程与Johnson草案描述的网关行为高度一致：它由Postfix调用，接收完整的邮件，然后利用ION-DTN（NASA开发的一款主流DTN协议栈）的库函数，将邮件封装成Bundle并注入本地的ION节点。BPMail为理论方案提供了实践验证，其封装邮件的过程，正是Blanchet草案试图标准化的核心操作。因此，BPMail是研究和仿真一个完整的、遵循前述系列草案思想的DTN电子邮件系统的理想工具。

#### **2.7 总结**

综上所述，文献研究已经为在DTN环境中实现电子邮件通信构建了一个清晰且协同工作的技术框架。从挑战性网络的需求分析，到DTN架构的提出，再到一系列协同定义网关服务接口（Johnson-SMTP）、数据格式（Blanchet-Email）和依赖解析（Johnson-DNS）的标准化草案，整个技术路线图已经相当完善。同时，BPMail等实践工具的存在也证明了该框架的可行性。

然而，现有研究仍存在明显的**空白**：

大多数文献和草案侧重于体系结构的设计和可行性的定性描述，但缺乏在一个软件模拟环境下对该协同方案进行局限性分析。

具体而言，以下问题尚待深入回答：

1. **架构层面的局限性——用户移动场景的缺失**：当前的网关方案隐性地假设了用户的网络接入点（即其DTN网关节点）是固定的。方案并未考虑在星际航行等场景中，**用户本身跨越星球或大型栖息地时**，其邮件路由和地址应如何动态更新的问题。本研究将探讨这一场景缺失对方案完整性的影响。
3. **实现层面的局限性——对复杂邮件的处理能力**：理论方案需要通过具体软件来实现，而软件实现本身可能存在瓶颈。以本设计采用的核心网关工具**BPMail**为例，其在处理现实世界中的复杂邮件，特别是**含有大附件的邮件**时，其性能表现、资源消耗和潜在的故障点是什么？这是衡量方案实用性的一个关键指标。

因此，本毕业设计的研究价值在于填补上述空白。通过在一个高度可控的容器化环境中，仿真并复现一个完整的、包含真实邮件服务器与客户端的DTN电子邮件系统，本研究旨在**定量地回答该系列方案在组合工作时的实际性能表现，并深入剖析其潜在的局限与不足**，从而为该技术的未来优化和实际部署提供有价值的参考数据。



Chapter3 System Design

#### 3.1 引言

本章旨在详细阐述仿真测试平台的总体架构、关键技术选型及其设计理由。一个设计良好、科学合理的仿真平台是确保研究结果有效性和可信性的基石。

本次系统设计的核心目标，是创建一个能够**可靠复现**`Johnson Draft`端到端工作流程，并能**灵活模拟**不同深空网络环境的测试平台。为达成此目标，本设计遵循以下核心原则：

- **模块化 (Modularity):** 将系统划分为功能独立的子系统（服务器、用户），便于配置、测试不同的使用场景。
- **可复现性 (Reproducibility):** 采用容器化技术，确保整个实验环境可以被精确、一致地重建，保证实验结果的科学有效性。
- **真实性 (Authenticity):** 尽可能采用业界主流和真实的软件（如Postfix, Thunderbird）而非简化的脚本，以最大程度地模拟真实应用场景。
- **可控性 (Controllability):** 网络环境（延迟、中断）必须是可量化、可精确控制的，为后续的性能分析提供基础。

#### **3.2 系统总体架构**

为达成上述目标，本设计构建了一个基于Docker容器的五节点仿真模型，其总体架构如下图 3-1 所示。

**图 3-1 系统总体架构图**

该架构模拟了两个逻辑上分离的网络区域：“地球互联网 (Earth Internet)” 和 “月球互联网 (Moon Internet)”，两者之间通过一个模拟的、存在长延迟的DTN链路连接。

- **逻辑区域划分**:
  - **地球互联网 (Earth Internet)**: 包含 `mail-server-1` (IP: `172.21.0.3`) 和 `client-1` (IP: `172.21.0.4`) 两个容器，它们位于 `172.21.0.0/24` 网段，模拟地球上的邮件服务器和用户终端。
  - **月球互联网 (Moon Internet)**: 包含 `mail-server-2` (IP: `172.22.0.3`) 和 `client-2` (IP: `172.22.0.4`) 两个容器，它们位于 `172.22.0.0/24` 网段，模拟月球上的对应设施。
- **核心组件角色**:
  - **邮件服务器 (`mail-server-1`, `mail-server-2`)**: 作为各自网络区域的核心，负责邮件的收发和存储。它们内部署了完整的邮件服务套件和DTN网关功能。
  - **用户终端 (`client-1`, `client-2`)**: 模拟终端用户，通过邮件客户端软件与各自区域的邮件服务器交互。
  - **延迟模拟节点 (`Delay Node`)**: 这是一个关键的中间节点，它桥接了地球和月球两个网络。在本设计中，它扮演了**网络损伤模拟器**的角色。所有跨区域的通信都必须经过此节点，以便施加可控的网络延迟和中断。
- **数据流（以地球发送到月球为例）**:
  1. `client-1` 的Thunderbird用户撰写邮件，通过SMTP协议发送给`mail-server-1`上的Postfix。
  2. Postfix根据路由规则，将邮件交给本地的`BPMailSend`（网关发送组件）处理。
  3. `BPMailSend`将整个邮件封装成Bundle，通过DTN网络发送给Delay Node。
  4. 经过设定的延迟后，Delay Node将Bundle转发到`mail-server-2`。
  5. `mail-server-2`上的`BPMailRecv`（网关接收组件）接收Bundle，解包还原成原始邮件。
  6. `BPMailRecv`通过SMTP协议将邮件投递给本地的Postfix，最终由Dovecot存入用户邮箱。
  7. `client-2`的Thunderbird用户通过IMAP协议从服务器获取并阅读新邮件。

这种分离式的架构清晰地模拟了多节点、跨网络的分布式通信场景，为后续的仿真分析提供了坚实的基础。

#### **3.3 仿真环境与容器化技术选型**

**技术选型：Docker**

本次仿真实验的底层承载平台选用Docker。Docker是一个开源的应用容器引擎，它允许开发者将应用以及应用的依赖打包到一个可移植的容器中。

**选择理由：** 选择Docker是基于其在环境隔离、可复现性和资源效率方面的巨大优势，这使其成为进行此类网络仿真的理想选择。

- **轻量级与高资源利用率**: 与传统的虚拟机（VM）相比，Docker容器共享主机的操作系统内核，无需为每个实例运行一个完整的操作系统。这使得容器非常轻量，启动速度快（秒级），并且在一台物理机上可以同时运行更多的实例（例如本设计的5个），极大地提高了硬件资源的利用率。
- **环境隔离与一致性**: Docker为每个容器提供了独立的文件系统、进程空间和网络栈。这完美地解决了在单一主机上部署多个Postfix或ION节点时可能出现的端口冲突和库依赖版本不兼容的问题，保证了每个组件运行在干净、无干扰的环境中。
- **保证科学实验的可复现性**: 通过`Dockerfile`和`docker-compose`，整个复杂的实验环境可以被代码化。这份“蓝图”精确定义了基础镜像、所有软件的安装步骤、配置文件的内容以及服务的启动顺序。这意味着任何研究者都可以在任何支持Docker的机器上一键部署与本研究完全一致的仿真环境，这是保证科学实验结果可被验证和复现的核心要求。

##### **3.3.1 与其他方案的对比**

为了进一步凸显Docker方案的优越性，在此与另外两种可行的方案进行对比：

- **对比Linux虚拟机（VM）方案**:
  - **资源开销**: 运行5个独立的Linux虚拟机需要巨大的内存和磁盘开销，因为每个虚拟机都包含一个完整的客户操作系统。而5个Docker容器的开销则小得多，使得在普通个人电脑或单台服务器上进行实验成为可能。
  - **部署效率**: 创建和配置一个VM通常需要数分钟甚至更长时间，而利用缓存的镜像启动一个Docker容器仅需数秒。在需要频繁重建和调整实验环境的调试阶段，Docker的效率优势尤为明显。
- **对比物理硬件（树莓派）方案**:
  - 在项目“SMTP Gatewaying Across Delay Tolerant Networks”中，研究者使用了多个树莓派（Raspberry Pi）物理设备来搭建测试平台。虽然这种方法直观且接近物理现实，但对于本研究的目标而言，Docker方案更为方便。
  - **成本与可扩展性**: 物理方案需要采购、部署和维护多台硬件设备及相应的网络配件，成本较高且不易扩展。而Docker方案在单一主机上即可模拟任意数量的节点，成本极低，扩展性强。
  - **控制与环境一致性**: 物理硬件易受网络线缆、电源、SD卡性能等物理因素的干扰。Docker提供了一个纯软件定义的、高度受控的虚拟环境，可以精确控制网络拓扑和参数，排除了物理世界的不可控变量，更适合进行需要精确控制变量的科学仿真实验。

#### **3.4 传统电子邮件子系统设计**

**技术选型：Postfix (MTA), Dovecot (MDA/IMAP Server), Thunderbird (MUA)**

- **Postfix**: 选择Postfix作为MTA，因为它是一个在安全性、稳定性和性能方面享有盛誉的开源软件。其高度模块化的设计和清晰的配置文件，特别是其灵活的`transport_maps`和`master.cf`配置，为后续**集成BPMail作为自定义投递代理**提供了完美的接口。
- **Dovecot**: 选择Dovecot作为IMAP服务器，因为它被公认为当前性能最高、最安全的开源IMAP/POP3服务器之一。它与Postfix的集成非常成熟，能够为用户提供稳定可靠的邮件存储和访问服务（Message Store）。
- **Thunderbird**: 选择Thunderbird作为MUA，而不是使用脚本来发信，是为了**提升仿真的真实性**。Thunderbird是一个功能齐全的真实世界客户端，它会产生标准的、包含各种头部和MIME格式的邮件，确保我们的系统测试的是真实的用户行为和数据。

#### **3.5 延迟容忍网络（DTN）子系统设计**

**技术选型：ION-DTN (Bundle Protocol实现), BPMail (SMTP-DTN网关)**

- **ION-DTN**: 选择ION-DTN作为Bundle协议的实现，具有**权威性和行业标准**的双重意义。它由NASA/JPL开发和维护，是深空通信和DTN研究领域是目前深空通信和DTN协议栈中最为知名、应用最广的实现之一。使用ION能够确保我们的仿真是在一个经过真实空间任务检验的、健壮可靠的DTN协议栈上进行的，极大地增强了本研究结果的可信度。
- **BPMail**: 选择BPMail是本次设计的**关键连接点**。它是目前已知的、为数不多的、专门为实现`draft-johnson`网关思想而设计的开源工具。它能够直接与Postfix和ION-DTN集成，**是目前公开可用、成熟度较高，并与主流DTN实现（ION-DTN）高度集成的邮件-DTN桥接方案之一**。选择BPMail使得我能够专注于方案本身的分析，而不是耗费精力去从零开发一个复杂的网关。

#### **3.6 网络延迟模拟层设计**

**技术选型：Linux Traffic Control (`tc qdisc netem`)**

- **内核级实现，高性能与高精度**: `tc`是Linux内核自带的流量控制模块，直接在内核的网络协议栈中对数据包进行处理，性能开销极小，且能提供精确的时延和丢包控制。
- **功能强大且标准化**: `netem`（Network Emulator）是`tc`的一个队列规定（qdisc），提供了增加延迟、丢包等多种网络损伤功能，完全满足本设计模拟长延迟和连接中断（通过100%丢包实现）的需求。它是学术界和工业界进行网络模拟测试的**标准工具**。
- **易于集成**: 在Docker容器中，可以直接调用`tc`命令来修改网络接口的属性，与我们的容器化方案无缝集成。

#### **3.7 本章小结**

本章详细阐述了仿真平台系统设计。通过对总体架构的描绘和对各子系统技术选型的理由分析，确立了一套基于Docker容器化技术，有机集成了Postfix、Dovecot、Thunderbird、ION-DTN、BPMail及`tc`等一系列成熟、主流技术的解决方案。该设计方案在模块化、可复现性、真实性和可控性方面均表现出显著优势，尤其是在与其他可行方案（如虚拟机和物理硬件）的对比中，更凸显了其作为科学仿真平台的适宜性。这个设计方案为下一章“系统实现”的具体部署工作和后续“结果分析”的数据采集奠定了坚实的基础。



Chapter4 Implementation

#### **4.1 引言**

本章旨在详细阐述将第三章“系统设计”中的架构蓝图，转化为一个可运行、可测试的具体仿真平台的全部实践过程。内容将涵盖宿主环境的准备、核心组件的容器化构建、关键服务的自动化配置细节，以及如何通过Docker Compose对整个分布式系统进行自动化编排与一键式启动。本章所呈现的实现细节，为后续章节进行系统测试与性能分析提供了坚实的、可复现的实践基础。

#### **4.2 环境准备与依赖编译**

- **宿主环境与核心软件**: 本仿真平台在以下环境中进行开发与测试：

  - 宿主操作系统: Ubuntu 24.04.2 LTS
  - 容器化引擎: Docker Engine v28.0.4
  - 容器编排工具: Docker Compose v2.34.0

- **核心依赖编译**: 在实现过程中，一个关键的挑战是核心依赖库的版本管理问题。经调研发现，BPMail的成功编译和稳定运行，对其依赖库（尤其是`gmime`）有特定的最低版本要求。然而，项目所采用的`Ubuntu 24.04`官方软件仓库中提供的版本**过于陈旧**，无法满足这一要求。

  直接通过`apt-get`安装的方式不可行。因此，本设计采取了**从源码手动编译**的方案来解决此问题。具体实现是，将所需版本的依赖库源码与项目文件一同打包，并在`mail-server`容器的Dockerfile中，通过脚本自动化执行编译和安装流程。主要依赖包括：

  - **mbedtls** v2.28.8: 一个轻量级的开源TLS/SSL协议栈，为ION-DTN提供加密支持。
  - **gmime** v3.2.15: 一个用于解析和创建MIME消息的C语言库，是BPMail处理电子邮件内容的基础。
  - **c-ares** v1.34.4: 一个异步DNS请求库，供BPMail等网络应用使用。

  这种方式虽然增加了构建的复杂度，但带来了两个核心优势：第一，它**彻底解决了版本兼容性问题**，保证了上层应用BPMail的稳定运行；第二，它实现了对软件环境的**完全、精确的控制**，极大地增强了整个仿真平台的可复现性和可靠性，同时也体现了本次实现的深度与完整性。

#### **4.3 核心组件的容器化实现**

本节将深入每个独立组件的构建和配置细节。

##### **4.3.1 邮件服务器容器 (`mail-server`)**

邮件服务器容器是本仿真系统中最复杂的组件，它集成了邮件收发、DTN节点和网关三大功能。

- **Dockerfile剖析**: `mail-server/Dockerfile`文件定义了该容器的完整构建流程：

  1. **基础环境**: 选择`ubuntu:24.04`作为官方基础镜像。
  2. **安装核心服务**: 使用`apt-get`安装Postfix, Dovecot以及一系列编译和网络调试工具。
  3. **编译安装核心依赖库**: 为了满足BPMail和ION-DTN对特定库版本的要求，多个关键依赖库通过源码编译的方式进行安装。首先，通过`COPY`指令将`mbedtls`, `gmime`, `c-ares`的源码包复制到镜像的`/usr/local/src/`目录下。随后，Dockerfile依次进入各个源码目录，使用对应的构建系统完成编译和安装。
  4. **编译安装ION-DTN协议栈**: 在其加密库依赖`mbedtls`安装完成后，开始编译ION-DTN。构建脚本首先运行`autoreconf`来生成配置脚本，然后执行`./configure`并启用mbedtls加密支持（`--enable-crypto-mbedtls`），最后通过`make && make install`将其安装到系统中。`ldconfig`命令的执行确保了新安装的动态链接库能被系统正确找到。值得一提的是，ION-DTN的运行配置文件（如定义节点EID和接触计划的`.rc`文件）并未在容器启动时动态生成，而是在构建镜像前就已**预先配置完成，并作为源码的一部分被直接复制到镜像中**。这种做法简化了容器的启动脚本，使得编译安装完成后，启动脚本仅需进入指定目录并执行`ionstart`即可加载正确的配置并启动节点，进一步提高了部署的自动化程度和可靠性。
  5. **编译安装BPMail网关**: 在`gmime`和`c-ares`等依赖准备就绪后，最后进行BPMail自身的编译。BPMail项目使用`Meson`作为构建系统，Dockerfile通过`meson setup build`, `meson compile -C build`, 和 `meson install -C build`三条命令，高效地完成了编译和安装过程，将`bpmailsend`等核心程序部署到系统中。
  6. **安装Thunderbird客户端**: 为便于在容器内直接进行端到端的调试和功能验证，Dockerfile中也包含了Thunderbird的安装步骤。由于Ubuntu 24.04默认通过Snap包管理器安装Thunderbird，这在容器化环境中存在兼容性和管理上的不便。为绕过此限制，Dockerfile中通过`add-apt-repository`命令添加了Mozilla官方的PPA (`ppa:mozillateam/ppa`)，并配置了APT优先级，从而能够通过传统方式 (`apt-get`) 安装`.deb`格式的Thunderbird软件包，保证了其在容器环境中的良好运行。

  Dockerfile

  ```
  RUN add-apt-repository ppa:mozillateam/ppa
  RUN cat <<EOF > /etc/apt/preferences.d/mozilla-ppa
  Package: *
  Pin: release o=LP-PPA-mozillateam
  Pin-Priority: 1001
  EOF
  RUN apt-get update && apt-get install -y thunderbird
  ```

  7. **执行入口脚本**: 安装完所有组件后，指定`CMD`为入口脚本`/mail-server.sh`。

- **自动化配置与启动 (`mail-server.sh`)**: 该脚本是实现容器自动化配置的核心。当容器启动时，它会执行以下关键操作：

  1. **动态网络配置**: 根据从`docker-compose.yml`传入的`$GATEWAY`环境变量，动态设置容器的默认网关，确保其可以与“外部世界”（即`delay-server`）通信。

  2. **Postfix与BPMail集成**: 这是最关键的集成步骤。脚本通过判断`$HOSTNAME`环境变量来区分自身是`mail-1`还是`mail-2`，并执行差异化配置。

     - 向`master.cf`追加一个名为`bp`的`pipe`传输服务，该服务会调用`bpmailsend`程序来处理邮件。
     - 创建`/etc/postfix/transport`文件，将目标域（如`mail-2.a.com`）的邮件路由规则指向新定义的`bp`服务，并指定目标节点的ION EID（如`ipn:3.129`）。

     mail-server.sh

     ```
     MASTER_CF="/etc/postfix/master.cf"
     POSTFIX_TRANSPORT_FILE="/etc/postfix/transport"
     if [[ "$HOSTNAME" == "mail-1" ]]; then
         echo "bp        unix  -       n       n       -       -       pipe" >> "$MASTER_CF"
         echo "      flags=ODR user=user argv=/usr/local/bin/bpmailsend -t 1 21 \${nexthop}" >> "$MASTER_CF"
         echo "mail-2.a.com   bp:ipn:3.129" >> "${POSTFIX_TRANSPORT_FILE}"
         postmap "${POSTFIX_TRANSPORT_FILE}"
     elif [[ "$HOSTNAME" == "mail-2" ]]; then
         echo "bp        unix  -       n       n       -       -       pipe" >> "$MASTER_CF"
         echo "      flags=ODR user=user argv=/usr/local/bin/bpmailsend -t 2 21 \${nexthop}" >> "$MASTER_CF"
         echo "mail-1.a.com   bp:ipn:2.129" >> "${POSTFIX_TRANSPORT_FILE}"
         postmap "${POSTFIX_TRANSPORT_FILE}"
     fi
     ```

  3. **Dovecot配置**: 通过`sed`命令自动化修改Dovecot配置文件，以支持Maildir邮件存储格式，并与Postfix的LMTP投递方式正确衔接。

  4. **启动服务**: 按顺序启动`postfix`和`dovecot`服务，然后根据`$HOSTNAME`启动对应的ION节点和BPMail接收守护进程（`bpmail2postfix.sh`），确保了服务依赖关系的正确性。

##### **4.3.2 网络延迟模拟器容器 (`delay-server`)**

该容器结构简单但功能核心，其`Dockerfile`基于一个包含丰富网络工具的公共镜像`wbitt/network-multitool`，并仅复制和运行一个启动脚本。

- **网络损伤脚本 (`delay-server.sh`)**: 该脚本在容器启动时执行，负责为仿真平台注入网络延迟。

  delay-server.sh

  ```
  #!/bin/bash
  tc qdisc add dev eth0 root netem delay 1000ms
  tc qdisc add dev eth1 root netem delay 1000ms
  sysctl -w net.ipv4.ip_forward=1
  tail -f /dev/null
  ```

  脚本通过`tc qdisc`命令，分别为连接“地球”网络（`eth0`）和“月球”网络（`eth1`）的两个虚拟网卡添加了1000毫秒的固定延迟。同时，通过`sysctl`开启IP转发功能，使其能作为两个子网之间的路由器。在后续实验中，仅需修改此脚本即可模拟不同的网络延迟或中断场景。

##### **4.3.3 用户终端容器的实现**

在`docker-compose.yml`中，名为`mail-3` 、`mail-4`的服务实际扮演了用户终端`client-1`、`client-2`的角色。它使用了与邮件服务器相同的镜像，但其配置和用途完全不同。

- **图形界面转发**: 通过挂载Wayland相关的`volume`，实现了将容器内Thunderbird的GUI界面直接显示在宿主机桌面上，便于进行图形化操作。

  ```bash
    mail-3:
      build: ./mail-server
      hostname: mail-3
      environment:
        - HOSTNAME=mail-3
        - DOMAIN=a.com
        - GATEWAY=172.21.0.2
        - MOZ_ENABLE_WAYLAND=1
        - WAYLAND_DISPLAY=${WAYLAND_DISPLAY}
        - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
      volumes:
        - ${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}:${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}:ro
        - /home/peanuts/Code/thunderbird-profile:/root/.thunderbird
      networks:
        mail-1_net:
          ipv4_address: 172.21.0.4
      cap_add:
        - NET_ADMIN
  ```

- **自动化配置**: 最关键的实现是通过`volumes`将宿主机上的`thunderbird-profile`目录挂载到容器内的`/root/.thunderbird`。该Profile已预先手动配置好`user@mail-1.a.com`、`user@mail-2.a.com`的IMAP和SMTP服务器地址，并保存了信任证书。这实现了客户端的“开箱即用”，极大地提升了实验效率。

#### **4.4 系统编排与启动**

`docker-compose.yml`文件是整个仿真平台的“总指挥”，它定义并连接了所有组件。

- **服务定义 (`services`)**: 文件中清晰地定义了`delay-server`, `mail-1`, `mail-2`以及`mail-3`（客户端）四个核心服务。每个服务都指定了其构建上下文（`build`）、主机名（`hostname`）、静态IP地址、以及运行所需权限（`cap_add: [NET_ADMIN]`）。其中，最为关键的设计是利用**环境变量和启动脚本实现跨网段流量的强制路由**。具体而言：

1. 对于`mail-1`和`mail-2`等服务，通过`environment`字段为其注入了一个`GATEWAY`变量。该变量的值被设置为`delay-server`在该服务所在子网的IP地址（例如，为`mail-1`设置`GATEWAY=172.21.0.2`）。
2. 随后，容器内的`mail-server.sh`启动脚本会读取此`$GATEWAY`变量，并执行`ip route add default via $GATEWAY`命令。
3. 这一操作**动态地将容器的默认网关指向了`delay-server`**。

由于`delay-server`是唯一同时连接“地球”和“月球”两个子网的节点，这一设计强制所有跨区域（如从`mail-1`到`mail-2`）的IP流量都必须经过`delay-server`进行转发。这确保了我们在`delay-server`上使用`tc`设置的网络延迟能够被精确地施加在关键通信链路上，是整个延迟模拟得以实现的核心机制。

- **网络定义 (`networks`)**:

  ```
  networks:
    mail-1_net:
      driver: bridge
      ipam:
        driver: default
        config:
          - subnet: 172.21.0.0/24
    mail-2_net:
      # ... (similar configuration for 172.22.0.0/24) ...
  ```

  该部分定义了`mail-1_net`（地球）和`mail-2_net`（月球）两个独立的桥接网络，并为它们规划了不同的IP子网。`docker-compose.yml`的服务配置精确地将`mail-1`和`mail-3`连接到`mail-1_net`，将`mail-2`连接到`mail-2_net`。`delay-server`则唯一地同时连接到这两个网络，使其成为必然的通信中继点。

- **启动平台**: 完成上述定义后，整个仿真平台的启动分为**后台服务部署**和**前台客户端启动**两个阶段。这一多步过程确保了所有组件都能以正确的方式协同工作。

  1. **构建并启动后台服务**: 首先，在项目根目录下，需要为宿主机的X服务器授权，允许容器访问图形界面。随后，通过`docker compose`命令一键式地构建并启动所有后台服务容器（`mail-1`, `mail-2`, `delay-server`）以及客户端容器的“外壳”。

     ```
     # 构建并后台启动所有服务
     docker compose up -d --build
     ```

     `--build`参数确保了每次启动时都会基于最新的`Dockerfile`重新构建镜像。命令执行后，所有的服务器和网络环境便已在后台准备就绪。

  2. **启动图形化邮件客户端**: 后台服务启动后，需要手动进入客户端容器（在`docker-compose.yml`中名为`mail-3`）并启动Thunderbird。

     ```
     # 允许所有客户端连接到本地X server，以便显示GUI
     xhost +
     # 进入正在运行的客户端容器的交互式终端
     docker compose exec mail-3 /bin/bash
     ```

     成功进入容器的bash终端后，再执行：

     ```
     # 在容器内启动Thunderbird程序
     thunderbird
     ```

     执行此命令后，得益于预先配置的Wayland/X11转发和挂载的Profile数据卷，图形化的Thunderbird界面将会在宿主机桌面上弹出，并且所有邮箱账户均已配置完毕，可以直接进行邮件收发实验。

  通过以上步骤，一个从后台服务器到前台图形化客户端的、功能完备的端到端仿真平台便搭建完成并准备就绪。

#### **4.5 本章小结**

本章详细记录了将设计蓝图付诸实践的全过程。通过结合使用Dockerfile进行组件封装、Shell脚本进行自动化配置以及Docker Compose进行系统编排，成功地将一个涉及多种软件和复杂配置的分布式系统，转变成了一个自动化的、一键式的仿真平台。从第三方库的源码编译，到Postfix与BPMail的深度集成，再到网络环境的精确控制，各项关键实现细节均得到了清晰的阐述。至此，一个功能完备、高度可控的实验环境已部署完毕，为下一章进行系统性测试和局限性分析做好了充分的准备。



Chapter5 Results and Discussion

#### **5.1 引言**

本章旨在呈现并分析在前述仿真平台上所进行的系列实验结果，并对结果进行深入的讨论。首先，本章将以标准场景下系统的正常工作流程作为分析基线。随后，将重点引入一个更具挑战性的“用户跨星球移动”场景，通过定量测试数据，揭示当前`draft-johnson`方案在该场景下存在的性能局限。最后，在对这些局限性进行深入讨论的基础上，本章将结合相关领域的研究背景，提出一个概念性的改进方案，以应对所发现的挑战。

#### **5.2 基线场景回顾：网关中继模式**

在标准工作模式下，邮件的收发完全依赖于DTN网关进行中继。例如，当“地球”用户向“月球”用户发送邮件时，邮件被提交给本地的`mail-server-1`，由`BPMailSend`网关组件将其封装为Bundle，通过DTN链路异步地、可靠地传输至`mail-server-2`，并由`BPMailRecv`解包后投递给最终用户。在此模式下，整个过程对于终端用户是透明的，交互体验流畅，高延迟的星际链路被DTN网关和Bundle协议完全屏蔽。

#### **5.3 关键测试场景：用户跨星球移动与邮件获取**

##### **5.3.1 场景描述与问题分析**

现有DTN邮件网关方案的一个核心假设是，用户的MUA（邮件客户端）和其归属的MTA/MDA（邮件服务器）位于同一个低延迟的“局域网”内。然而，一个实际且重要的问题是：**当用户在星体之间旅行时，他们应如何访问自己的邮件？**

本研究设计的关键测试场景如下：一个归属于**“月球”**的用户（其邮箱位于`mail-server-2`），因任务需要旅行到了**“地球”**。此时，他使用地球上的设备（`client-1`）尝试连接并同步他在`mail-server-2`上的所有邮件。

在此场景下，问题立刻显现。如图 5-2所示，用户的Thunderbird客户端被配置为直接连接其归属服务器`mail-server-2`的IP地址。由于`mail-server-2`位于遥远的“月球”，这个IMAP连接请求必须**跨越整个存在长延迟的星际链路**。DTN网关在此过程中完全被旁路（bypassed），因为IMAP是一个端到端的、基于TCP的实时同步协议，它无法被`BPMail`这样的异步网关所处理。

**图 5-2 用户在地球直接获取月球邮件的问题场景**

##### **5.3.2 实验结果**

为了量化这一问题带来的影响，本实验测试了在不同网络延迟下，位于“地球”的客户端从“月球”服务器同步1000封简单邮件（正文为"Hello"）所需的总时间。实验结果如下表所示。

**表格 5-1 不同延迟下的邮件获取时间**

从表格 5-1 中可以清晰地看到，邮件获取时间随着单向延迟的增加而急剧恶化。在0秒延迟（局域网环境）下，获取邮件仅需19秒。但当延迟达到5秒时，完成同步需要153秒（超过2分半钟），此时用户体验已变得难以忍受，系统基本处于不可用状态。

#### **5.4 结果讨论与局限性分析**

上述实验结果定量地揭示了`draft-johnson`方案在设计上的多重局限性。

##### **5.4.1 性能局限：缺乏对用户移动性的支持**

实验数据最直观地证明了该方案在**用户移动性（User Mobility）**支持上的缺失。该方案的有效性，建立在将用户实时交互（Client-Server）与服务器间异步中继（Server-Server）分离的基础上，并仅对后者应用DTN技术。当用户漫游时，原本应在本地低延迟网络中完成的“用户交互”变成了跨星际的长延迟通信，导致整个系统的延迟容忍优势荡然无存。IMAP/SMTP这类“话痨”协议（Chatty Protocols）在长延迟链路上的性能崩溃问题，是导致性能急剧下降的根本原因。

##### **5.4.2 实现局限性：大附件处理失败**

在测试过程中，我们发现了当前方案在实际应用中的一个瓶颈：作为核心网关的**BPMail实现，无法正确处理带有大附件的邮件。**

当尝试通过网关发送一封带有较大附件（例如，3MB）的邮件时，邮件投递会失败。

该问题的原因很可能源于BPMail软件自身的内存管理机制。例如，程序可能尝试将整个邮件内容一次性读入内存中的一个固定大小的缓冲区，当邮件大小超出预期时，便会导致缓冲区溢出或内存分配失败。

这一实现上的缺陷，限制了该实现的实用性。在现代通信中，邮件不仅仅是文本的载体，更是文件和数据交换的重要工具。

#### **5.5 改进方案探讨与相关研究**

针对上述发现的局限性，特别是在用户移动性方面的挑战，本节将结合相关研究背景，提出一个概念性的改进方案。

实际上，本研究中发现的问题，在更广泛的延迟容忍网络研究中，通常被归纳为**“移动性管理”（Mobility Management）**的范畴。现有研究主要从两个层面寻求解决方案：一是**网络层**，旨在通过动态路由协议或目录服务，实现对移动节点位置的追踪和数据的透明转发；二是**应用层**，其核心思想是通过设置**代理（Proxy）或缓存（Cache）**，将用户与服务的实时交互限制在本地，而在后台进行异步的数据同步。例如“数据骡子”（Data Mules）等概念，就是应用层数据摆渡思想的体现。

考虑到网络层方案的巨大复杂性，应用层代理是更为务实和快速见效的路径。为此，本研究提出的“按需同步代理”（On-demand Sync Agent）模型，便属于应用层解决方案的一种具体构想，其架构如图 5-3所示。

**图 5-3 基于按需同步代理的改进方案概念模型**

这个**设想中**的架构，其工作逻辑如下：

1. **引入本地同步代理**: 在每个星球（如地球）上，部署一个“同步代理”服务。这个服务对用户来说，就是一个功能完整的本地邮件服务器。
2. **用户交互本地化**: 漫游到地球的月球用户，其Thunderbird客户端不再直接连接月球的服务器，而是连接到这个位于地球本地的同步代理服务器，从而保证交互的流畅性。
3. **后台DTN同步**: “同步代理”服务在后台负责通过DTN网关，与用户位于月球的归属服务器（`mail-server-2`）进行邮件的批量、异步同步。

这个概念模型通过引入一个中间代理层，将用户的前台实时交互与后台的异步数据同步彻底解耦，**有望解决**漫游带来的性能问题。

**当然，必须强调的是，这只是一个用于启发未来研究的初步架构设想。** 该方案的实际性能、同步策略（如冲突解决、同步频率）、安全性以及部署和维护的复杂性等一系列问题，都有待于在未来的工作中通过进一步的详细设计、原型实现与实验测试来深入探索和验证。

#### **5.6 本章小结**

本章通过设计并测试一个关键的“用户跨星球移动”场景，成功地识别并验证了现有DTN邮件网关方案的多重局限性。首先，定量实验数据显示，在漫游场景下直接访问远端邮件服务器会导致严重的性能问题。其次，功能测试发现，作为核心组件的BPMail网关无法处理大附件，暴露了方案在**软件实现层面**的不足。在对这些局限性进行讨论后，本章结合DTN移动性管理的相关研究背景，提出了一个基于“按需同步代理”的应用层改进模型，为解决该方案的根本缺陷提供了清晰、可行的概念性思路。



Chapter6 Conclusions and Future Work 41

 6.1 Conclusion

本毕业设计成功地完成了一项针对现代延迟容忍电子邮件方案的系统性仿真与分析。首先，在**系统实现**方面，本研究基于Docker容器化技术，搭建了一个由邮件服务器（Postfix/Dovecot）、客户端（Thunderbird）、DTN协议栈（ION-DTN）、邮件网关（BPMail）和网络模拟器（`tc`）组成的、可复现的仿真平台。

在**实验测试**环节，本研究设计并验证了一个关键的“用户跨星球移动”漫游场景。测试结果明确地揭示了该方案在架构设计上的核心**问题**：当用户漫游至远端网络并尝试访问其归属邮件服务器时，实时同步协议（IMAP/SMTP）因必须跨越长延迟链路而导致性能急剧下降，以致系统不可用。这证明了`draft-johnson`方案在设计上**不支持用户移动性**。此外，在功能测试中还发现了作为核心组件的BPMail网关无法处理大附件的实现缺陷，限制了其应用价值。

为解决移动性问题，本研究提出了一个基于“**按需同步代理**”的**概念**模型。该模型通过在用户本地设置一个中间代理，将用户与邮件系统的实时交互和后台跨星球的数据异步同步进行解耦，为解决该局限性提供了一个解决思路。

6.2 Limitations

尽管本研究达成其核心目标，但仍存在以下局限性：

1. **网络环境模拟简化**：本仿真主要集中于模拟深空网络最显著的**长延迟**特征。对于误码率、非对称带宽、周期性中断等其他复杂的网络状况未进行深入的组合测试。
2. **缺乏DNS及安全机制模拟**：为了聚焦于核心的邮件传输与同步问题，本次实现简化了DNS服务器的配置，因此未能通过实验去验证在漫游场景下，依赖于DNS的邮件信任机制（如SPF、DKIM）可能出现的故障。
3. **“按需同步代理”方案未经证实**：论文中提出的改进方案仅停留在**概念设计阶段**，其有效性、性能增益以及可能引入的新问题（如数据同步冲突）都未经原型实现和实验验证。

6.3 FutureWork

基于本研究的发现与局限，未来的研究可以从以下几个方面展开：

1. **改进DTN网关以支持大文件**：最直接且具应用价值的工作是解决BPMail的缺陷。可通过调试和修复其源码，或开发一个更健壮的新一代邮件网关，以确保对大附件的可靠处理，扫清方案实用化的一个关键障碍。
2. **改进方案的实现与验证**：将“按需同步代理”模型从概念变为现实。通过开发原型系统，并在本仿真平台上进行部署测试，定量地评估其在用户漫游场景下相较于原方案的性能提升。
3. **在更恶劣的网络环境下进行测试**：在现有仿真平台的基础上，引入更复杂的网络损伤模型，综合模拟延迟、抖动、丢包、中断等多种情况，对DTN电子邮件方案的极限性能和健壮性进行更全面的压力测试。