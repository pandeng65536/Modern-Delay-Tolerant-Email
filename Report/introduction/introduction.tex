\chapter{Introduction - Chapter}

\section{Email Protocol}

\begin{itemize}
    \item \textbf{MUA (Mail User Agent)}: Also known as the email client, used by end users to send and receive emails.
    \item \textbf{MSA (Mail Submission Agent)}: Receives emails from the MUA and forwards them to the MTA.
    \item \textbf{MTA (Mail Transfer Agent)}: Transfers email between servers.
    \item \textbf{MDA (Mail Delivery Agent)}: Delivers the email to the recipientâ€™s mailbox.
    \item Note: Dovecot refers to the MDA as \textbf{LDA (Local Delivery Agent)}.
\end{itemize}
  
\begin{table}[h!]
    \centering
    \caption{Common Email Protocols and Their Port Numbers}
    \begin{tabular}{>{\bfseries}l l l}
    \toprule
    Protocol & Description & Port \\
    \midrule
    IMAP     & Internet Message Access Protocol & 143 \\
    IMAPS    & IMAP over SSL/TLS               & 993 \\
    POP3     & Post Office Protocol v3         & 110 \\
    POP3S    & POP3 over SSL/TLS               & 995 \\
    SMTP     & Simple Mail Transfer Protocol   & 25 \\
    SMTPS    & SMTP over SSL/TLS               & 465 \\
    \bottomrule
    \end{tabular}
\end{table}

\subsection{STARTTLS Support}

\noindent \textbf{STARTTLS} is a command that upgrades a plaintext connection to a secure one using SSL/TLS, without changing the default ports. It can be used with:

\begin{itemize}
  \item IMAP on port 143
  \item POP3 on port 110
  \item SMTP on port 25
\end{itemize}

\section{Email Server}

\begin{lstlisting}[caption={Run Email Server Using Docker}]
    docker-compose up -d
    
    # Send email
    docker exec -it mail1 bash
    echo "Hello from mail1" | mail -s "Test Email" user1@mail.2.com
    
    docker exec -it mail2 bash
    cat /var/mail/user1
    
    # Reply email
    echo "Reply from mail2" | mail -s "Test Reply" user1@mail.1.com
    
    cat /var/mail/user1
    
    docker-compose down -v
\end{lstlisting}

\section{Simulate the Network}
0. WSL2 cannot be used because tc is not supported.

1. Use wbitt/network-multitool as the base image for the delay-server.

2. Create two distinct Docker networks and configure other containers (e.g., mail1, mail2) to use the delay-server as their default gateway by modifying their internal routing tables.

3. On the delay-server, apply iptables MASQUERADE rules for traffic routed between the networks, and add network delay to its interfaces using tc.

4. In the client containers (e.g., mail1, mail2), update their /etc/hosts files to resolve hostnames of other services to their respective IP addresses across the different networks.

5. Give priority to resolving domain names with the local hosts file by setting smtp host lookup = native.

6. Create transport maps to prevent Postfix from looking up MX records.

\section{Email Server Solution}

\begin{table}[h!]
\centering
\renewcommand{\arraystretch}{1.2}
\begin{tabular}{|p{2.6cm}|p{3.2cm}|p{3.2cm}|p{3.2cm}|p{3.2cm}|}
\hline
\textbf{Feature} & \textbf{maddy} & \textbf{Mailcow} & \textbf{iRedMail} & \textbf{Mail-in-a-Box} \\
\hline
Deployment & Docker & Docker Compose & Manual & Manual \\
\hline
MTA & maddy & Postfix & Postfix & Postfix \\
\hline
Mail Storage & maddy & Dovecot & Dovecot & Dovecot \\
\hline
User Storage & File / SQLite/ Postgres/MySQL & MySQL & MySQL / Postgres / LDAP & SQLite \\
\hline
Security Auth & DKIM / SPF / DMARC & DKIM / SPF / DMARC/ 2FA /SSL & DKIM / SPF / DMARC & DKIM / SPF / DMARC / SSL \\
\hline
Antispam & (Rspamd) & Rspamd & SpamAssassin & SpamAssassin \\
\hline
Antivirus & (ClamAV) & ClamAV & ClamAV & ClamAV \\
\hline
Content Filter & (Sieve) & Sieve & Amavisd & Amavisd \\
\hline
Admin Panel & (listmonk) & Web Panel & iRedAdmin & Web Panel \\
\hline
Webmail & (Roundcube) & SOGo & Roundcube/ SOGo & Roundcube \\
\hline
Desktop Client & (Thunderbird) & (Thunderbird) & (Thunderbird) & (Thunderbird) \\
\hline
Bulk/Lists & (listmonk) & Groups (built-in) & (Mailman) & Aliases / Forward \\
\hline
\end{tabular}
\caption{Comparison of mail system components and recommended technologies}
\end{table}

\section{Thunderbird}

I am running the Thunderbird graphical MUA inside a container, using Postfix to send and Dovecot to receive mail. To render the UI on my host, I use Wayland Socket Passthrough, which mounts the host's Wayland socket into the container. This allows me to configure and use Thunderbird's graphical interface directly on my Wayland desktop.